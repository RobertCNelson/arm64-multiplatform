From 5f7820b910f989029a8c1d65335ab6707ac251a6 Mon Sep 17 00:00:00 2001
From: Robert Nelson <robertcnelson@gmail.com>
Date: Wed, 26 Apr 2023 13:17:29 -0500
Subject: [PATCH 4/4] powervr clock

Signed-off-by: Robert Nelson <robertcnelson@gmail.com>
---
 .../devicetree/bindings/gpu/img,powervr.yaml  | 52 +++++++++++++++----
 drivers/gpu/drm/imagination/pvr_device.c      |  8 +--
 .../gpu/drm/imagination/pvr_rogue_fwif_sf.h   |  4 +-
 3 files changed, 47 insertions(+), 17 deletions(-)

diff --git a/Documentation/devicetree/bindings/gpu/img,powervr.yaml b/Documentation/devicetree/bindings/gpu/img,powervr.yaml
index 638c54689cc0..a4d900d2569e 100644
--- a/Documentation/devicetree/bindings/gpu/img,powervr.yaml
+++ b/Documentation/devicetree/bindings/gpu/img,powervr.yaml
@@ -2,13 +2,13 @@
 # Copyright (c) 2022 Imagination Technologies Ltd.
 %YAML 1.2
 ---
-$id: "http://devicetree.org/schemas/gpu/img-powervr.yaml#"
-$schema: "http://devicetree.org/meta-schemas/core.yaml#"
+$id: http://devicetree.org/schemas/gpu/img,powervr.yaml#
+$schema: http://devicetree.org/meta-schemas/core.yaml#
 
 title: Imagination Technologies PowerVR GPU
 
 maintainers:
-  - Sarah Walker <sarah.walker at imgtec.com>
+  - Sarah Walker <sarah.walker@imgtec.com>
 
 properties:
   compatible:
@@ -23,7 +23,6 @@ properties:
           - const: img,powervr-seriesaxe
 
   reg:
-    minItems: 1
     maxItems: 1
 
   clocks:
@@ -32,9 +31,9 @@ properties:
 
   clock-names:
     items:
-      - const: core_clk
-      - const: mem_clk
-      - const: sys_clk
+      - const: core
+      - const: mem
+      - const: sys
 
   interrupts:
     items:
@@ -48,6 +47,7 @@ properties:
     maxItems: 1
 
   operating-points-v2: true
+  opp-table: true
   power-supply: true
 
   "#cooling-cells":
@@ -61,6 +61,8 @@ required:
   - interrupts
   - interrupt-names
 
+additionalProperties: false
+
 allOf:
   - if:
       properties:
@@ -87,7 +89,7 @@ examples:
     #include <dt-bindings/interrupt-controller/irq.h>
     #include <dt-bindings/interrupt-controller/arm-gic.h>
 
-    gpu at 13000000 {
+    gpu@13000000 {
         compatible = "mediatek,mt8173-gpu", "img,powervr-series6xt";
         reg = <0 0x13000000 0 0xffff>, <0 0x13fff000 0 0x1000>;
         power-domains = <&scpsys MT8173_POWER_DOMAIN_MFG>;
@@ -96,10 +98,38 @@ examples:
         clocks = <&gpu_ckgen 0>,
                  <&gpu_ckgen 1>,
                  <&gpu_ckgen 2>;
-        clock-names = "core_clk",
-                      "mem_clk",
-                      "sys_clk";
+        clock-names = "core",
+                      "mem",
+                      "sys";
         interrupts = <GIC_SPI 217 IRQ_TYPE_LEVEL_LOW>;
         interrupt-names = "gpu";
     };
 
+    gpu_opp_table: opp-table {
+      compatible = "operating-points-v2";
+
+      opp-598000000 {
+        opp-hz = /bits/ 64 <598000000>;
+        opp-microvolt = <1130000>;
+      };
+      opp-494000000 {
+        opp-hz = /bits/ 64 <494000000>;
+        opp-microvolt = <1130000>;
+      };
+      opp-455000000 {
+        opp-hz = /bits/ 64 <455000000>;
+        opp-microvolt = <1000000>;
+      };
+      opp-396500000 {
+        opp-hz = /bits/ 64 <396500000>;
+        opp-microvolt = <1000000>;
+      };
+      opp-299000000 {
+        opp-hz = /bits/ 64 <299000000>;
+        opp-microvolt = <1000000>;
+      };
+      opp-253500000 {
+        opp-hz = /bits/ 64 <253500000>;
+        opp-microvolt = <1000000>;
+      };
+    };
diff --git a/drivers/gpu/drm/imagination/pvr_device.c b/drivers/gpu/drm/imagination/pvr_device.c
index 200c25f1499b..8afc7070370c 100644
--- a/drivers/gpu/drm/imagination/pvr_device.c
+++ b/drivers/gpu/drm/imagination/pvr_device.c
@@ -121,18 +121,18 @@ static int pvr_device_clk_init(struct pvr_device *pvr_dev)
 	pvr_dev->sys_clk = NULL;
 	pvr_dev->mem_clk = NULL;
 
-	core_clk = devm_clk_get(drm_dev->dev, "core_clk");
+	core_clk = devm_clk_get(drm_dev->dev, "core");
 	if (IS_ERR(core_clk)) {
 		err = PTR_ERR(core_clk);
-		drm_err(drm_dev, "failed to get core_clk (err=%d)\n", err);
+		drm_err(drm_dev, "failed to get core clock (err=%d)\n", err);
 		goto err_out;
 	}
 
-	sys_clk = devm_clk_get(drm_dev->dev, "sys_clk");
+	sys_clk = devm_clk_get(drm_dev->dev, "sys");
 	if (IS_ERR(sys_clk))
 		sys_clk = NULL;
 
-	mem_clk = devm_clk_get(drm_dev->dev, "mem_clk");
+	mem_clk = devm_clk_get(drm_dev->dev, "mem");
 	if (IS_ERR(mem_clk))
 		mem_clk = NULL;
 
diff --git a/drivers/gpu/drm/imagination/pvr_rogue_fwif_sf.h b/drivers/gpu/drm/imagination/pvr_rogue_fwif_sf.h
index 7cadfa0b730d..604e3dafa589 100644
--- a/drivers/gpu/drm/imagination/pvr_rogue_fwif_sf.h
+++ b/drivers/gpu/drm/imagination/pvr_rogue_fwif_sf.h
@@ -216,7 +216,7 @@ X(150, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_UNKNOWN_COMMAND_DEPRECATED, "Unknow
 X(151, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_UFO_FORCED_UPDATE, "UFO forced update: FWCtx 0x%08.8x @ %d [0x%08.8x] = 0x%08.8x", 4) \
 X(152, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_UFO_FORCED_UPDATE_NOP, "UFO forced update NOP: FWCtx 0x%08.8x @ %d [0x%08.8x] = 0x%08.8x, reason %d", 5) \
 X(153, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_TDM_BRN66075_CHECK, "TDM context switch check: Roff %u points to 0x%08x, Match=%u", 3) \
-X(154, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_OS_INIT_CCBS, "OSid %d CCB init status: %d (1-ok 0-fail): kCCBCtl at 0x%x kCCB at 0x%x fwCCBCtl at 0x%x fwCCB at 0x%x", 6) \
+X(154, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_OS_INIT_CCBS, "OSid %d CCB init status: %d (1-ok 0-fail): kCCBCtl@0x%x kCCB@0x%x fwCCBCtl@0x%x fwCCB@0x%x", 6) \
 X(155, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_FWIRQ, "FW IRQ # %u @ %u", 2) \
 X(156, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_BREAKPOINT_SET, "Setting breakpoint: Addr 0x%08.8x DM%u usc_breakpoint_ctrl_dm = %u", 3) \
 X(157, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_INVALID_KERNEL_CCB_DEPRECATED, "Invalid KCCB setup for OSid %u: KCCB 0x%08x, KCCB Ctrl 0x%08x", 3) \
@@ -227,7 +227,7 @@ X(161, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_FLUSHINVAL_CMD_INVALID_DEPRECATED,
 X(162, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_INVALID_NOTIFY_WRITE_OFFSET_UPDATE_DEPRECATED, "Invalid Write Offset update notification from OSid %u to DM %u: FWCtx 0x%08x, MemCtx 0x%08x", 4) \
 X(163, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_INVALID_KCCB_KICK_CMD_DEPRECATED, "Null FWCtx in KCCB kick cmd for OSid %u: KCCB 0x%08x, ROff %u, WOff %u", 4) \
 X(164, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_FULL_CHPTCCB, "Checkpoint CCB for OSid %u is full, signalling host for full check state (Roff = %u, Woff = %u)", 3) \
-X(165, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_OS_INIT_CCBS_DEPRECATED, "OSid %d CCB init status: %d (1-ok 0-fail): kCCBCtl at 0x%x kCCB at 0x%x fwCCBCtl at 0x%x fwCCB at 0x%x chptCCBCtl at 0x%x chptCCB at 0x%x", 8) \
+X(165, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_OS_INIT_CCBS_DEPRECATED, "OSid %d CCB init status: %d (1-ok 0-fail): kCCBCtl@0x%x kCCB@0x%x fwCCBCtl@0x%x fwCCB@0x%x chptCCBCtl@0x%x chptCCB@0x%x", 8) \
 X(166, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_OS_STATE_CHANGE, "OSid %d fw state transition request: from %d to %d (0-offline 1-ready 2-active 3-offloading). Status %d (1-ok 0-fail)", 4) \
 X(167, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_STALE_KCCB_CMDS, "OSid %u has %u stale commands in its KCCB", 2) \
 X(168, ROGUE_FW_GROUP_MAIN, ROGUE_FW_SF_MAIN_TA_VCE_PAUSE, "Applying VCE pause", 0) \
-- 
2.39.2

